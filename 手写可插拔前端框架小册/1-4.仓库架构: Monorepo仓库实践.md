### è¯¥å°èŠ‚ä¸»è¦çŸ¥è¯†ç‚¹ï¼š

-   ä»€ä¹ˆæ˜¯ <span style="color: #ff502c;background-color: #fff5f5">Monorepo</span> ?
-   â­ï¸â­ï¸â­ï¸â­ æ­å»º mini-umi é¡¹ç›®å¹¶<span style="color: #ff502c;background-color: #fff5f5">å®è·µ</span> <span style="color: #ff502c;background-color: #fff5f5">Monorepo</span> ç»„ç»‡ç®¡ç†
-   Monorepo ä¸­çš„ <span style="color: #ff502c;background-color: #fff5f5">æ„å»ºé¡ºåº</span>é—®é¢˜ ä¸ <span style="color: #ff502c;background-color: #fff5f5">å¾ªç¯ä¾èµ–</span>
-   <span style="color: #ff502c;background-color: #fff5f5">Turborepo</span> <span style="color: #ff502c;background-color: #fff5f5">é«˜æ€§èƒ½</span>æ„å»ºç³»ç»Ÿ æ¥å…¥ä¸<span style="color: #ff502c;background-color: #fff5f5">å¼€æºé¡¹ç›®</span>å®è·µ

>  æœ¬å°èŠ‚æ‰€æœ‰ä»£ç å·²æ”¾å…¥ [mini-umi](https://github.com/BoyYangzai/mini-umi) ä»“åº“ <span style="color: #ff502c;background-color: #fff5f5">/juejin/mini-umi</span>ç›®å½• ä¸‹


# ä»€ä¹ˆæ˜¯ <span style="color: #ff502c;background-color: #fff5f5">Monorepo</span> ?
Monorepo æ˜¯ä¸€ç§ç»„ç»‡ç®¡ç†ä»£ç çš„æ–¹å¼ï¼ŒæŒ‡åœ¨<span style="color: #ff502c;background-color: #fff5f5">ä¸€ä¸ª git ä»“åº“</span>ä¸­ç®¡ç†<span style="color: #ff502c;background-color: #fff5f5">å¤šä¸ªé¡¹ç›®</span><br>
é¡¹ç›®ç»“æ„ä¸€èˆ¬ä¸ºï¼š
```js
.
â”œâ”€â”€ package.json
â””â”€â”€ packages
    â”œâ”€â”€ packageA 
    â”œâ”€â”€ packageB
    â””â”€â”€ packageC
```

### è¿™æ ·ç®¡ç†ä»“åº“æœ‰ä»€ä¹ˆ <span style="color: #ff502c;background-color: #fff5f5">å¥½å¤„</span> å‘¢ï¼Ÿ
-   Monorepo å¯ä»¥é€šè¿‡ <span style="color: #ff502c;background-color: #fff5f5">workspace</span> å¿«é€Ÿ<span style="color: #ff502c;background-color: #fff5f5">è½¯é“¾æ¥</span>linkï¼Œæ–¹ä¾¿ npmåŒ… çš„<span style="color: #ff502c;background-color: #fff5f5">æœ¬åœ°å¼€å‘</span>
-   å¯ä»¥ä½¿ç”¨<span style="color: #ff502c;background-color: #fff5f5">ç»Ÿä¸€çš„å·¥ç¨‹åŒ–é…ç½®</span>  å¦‚ tsconfig eslint prettier ç­‰
-   æŠ½å–<span style="color: #ff502c;background-color: #fff5f5">å…¬å…±ä¾èµ–</span> å‡å°‘é‡å¤å®‰è£…

# æ­å»º mini-umi é¡¹ç›®å¹¶å®è·µ <span style="color: #ff502c;background-color: #fff5f5">Monorepo</span> ç»„ç»‡ç®¡ç†
## 1.æ ¹ç›®å½•æ­å»º
### æ–°å»ºé¡¹ç›®ç›®å½•

```
mkdir mini-umi
code mini-umi
```

### æ­å»ºé¡¹ç›®éª¨æ¶

```js
pnpm init  // æ–°å»º package.json
pnpm i typescript -d  // å®‰è£… typescript 
tsc --init  // æ–°å»º tsconfig æ–‡ä»¶
```

### ä¿®æ”¹tsconfig.json

```json
{
  "compilerOptions": {
    "strict": true,
    "declaration": true,
    "skipLibCheck": true,
    "baseUrl": "./",
    "moduleDetection": "auto",
    "esModuleInterop": true
  }
}
```

### ä½¿ç”¨ <span style="color: #ff502c;background-color: #fff5f5">father</span> ä»£æ›¿ <span style="color: #ff502c;background-color: #fff5f5">tsc</span>

### ä»€ä¹ˆæ˜¯ **father** ï¼Ÿ

father æ˜¯ <span style="color: #ff502c;background-color: #fff5f5">èš‚èšä½“éªŒæŠ€æœ¯éƒ¨</span>æ¨å‡ºçš„ä¸€æ¬¾ <span style="color: #ff502c;background-color: #fff5f5">NPM åŒ…ç ”å‘å·¥å…·</span>ï¼Œèƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…æ›´é«˜æ•ˆã€é«˜è´¨é‡åœ°ç ”å‘ NPM åŒ…ã€ç”Ÿæˆæ„å»ºäº§ç‰©ã€å†å®Œæˆå‘å¸ƒã€‚å®ƒä¸»è¦å…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š
>-   âš”ï¸ åŒæ¨¡å¼æ„å»ºï¼š æ”¯æŒ Bundless åŠ Bundle ä¸¤ç§æ„å»ºæ¨¡å¼ï¼ŒESModule åŠ CommonJS äº§ç‰©ä½¿ç”¨ Bundless æ¨¡å¼ï¼ŒUMD äº§ç‰©ä½¿ç”¨ Bundle æ¨¡å¼
>-   ğŸ› å¤šæ„å»ºæ ¸å¿ƒï¼š Bundle æ¨¡å¼ä½¿ç”¨ Webpack ä½œä¸ºæ„å»ºæ ¸å¿ƒï¼ŒBundless æ¨¡å¼æ”¯æŒ esbuildã€Babel åŠ SWC ä¸‰ç§æ„å»ºæ ¸å¿ƒï¼Œå¯é€šè¿‡é…ç½®è‡ªç”±åˆ‡æ¢
>-   ğŸ”– ç±»å‹ç”Ÿæˆï¼š æ— è®ºæ˜¯æºç æ„å»ºè¿˜æ˜¯ä¾èµ–é¢„æ‰“åŒ…ï¼Œéƒ½æ”¯æŒä¸º TypeScript æ¨¡å—ç”Ÿæˆ .d.ts ç±»å‹å®šä¹‰
>-   ğŸš€ æŒä¹…ç¼“å­˜ï¼š æ‰€æœ‰äº§ç‰©ç±»å‹å‡æ”¯æŒæŒä¹…ç¼“å­˜ï¼ŒäºŒæ¬¡æ„å»ºæˆ–å¢é‡æ„å»ºåªéœ€ã€å—–ã€çš„ä¸€ä¸‹
>-   ğŸ©º é¡¹ç›®ä½“æ£€ï¼š å¯¹ NPM åŒ…ç ”å‘å¸¸è§è¯¯åŒºåšæ£€æŸ¥ï¼Œè®©æ¯ä¸€æ¬¡å‘å¸ƒéƒ½æ›´åŠ ç¨³å¥
>-   ğŸ— å¾®ç”Ÿæˆå™¨ï¼š ä¸ºé¡¹ç›®è¿½åŠ ç”Ÿæˆå¸¸è§çš„å·¥ç¨‹åŒ–èƒ½åŠ›ï¼Œä¾‹å¦‚ä½¿ç”¨ jest ç¼–å†™æµ‹è¯•
>-   ğŸ“¦ ä¾èµ–é¢„æ‰“åŒ…ï¼š å¼€ç®±å³ç”¨çš„ä¾èµ–é¢„æ‰“åŒ…èƒ½åŠ›ï¼Œå¸®åŠ© Node.js æ¡†æ¶/åº“æå‡ç¨³å®šæ€§ã€ä¸å—ä¸Šæ¸¸ä¾èµ–æ›´æ–°å½±å“ï¼ˆå®éªŒæ€§ï¼‰
ä»¥ä¸Šæ‘˜è‡ª father-#README.md
### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨fatherï¼Ÿ

å› ä¸ºä»–å†…ç½®äº† <span style="color: #ff502c;background-color: #fff5f5">Bundless</span> å’Œ <span style="color: #ff502c;background-color: #fff5f5">Bundle</span> ä¸¤ç§æ„å»ºæ¨¡å¼ï¼Œè€Œä¸”å†…ç½®æœ‰å¾ˆæ–¹ä¾¿çš„è„šæ‰‹æ¶

tipsï¼šfather ä¹Ÿæ˜¯<span style="color: #ff502c;background-color: #fff5f5">åŸºäºUmiå¾®å†…æ ¸æ¶æ„</span>å¼€å‘çš„

### è¿™é‡Œæˆ‘ä»¬<span style="color: #ff502c;background-color: #fff5f5">ä¸ä½¿ç”¨</span> father å†…ç½®è„šæ‰‹æ¶

```
npm i father
```

### æ–°å»º .fatherrc.ts é…ç½®æ–‡ä»¶

```ts
import { defineConfig } from "father";

export default defineConfig({
  cjs: {
    output: 'dist',
    sourcemap: true
  }
})
```

### æ–°å»º src/index.ts

```ts
export const yang = 'yang'
console.log(yang);
```

### ä¿®æ”¹ package.json

```json
{
  "name": "mini-umi",
  "version": "1.0.0",
  "description": "a simple model for Umi",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "scripts": {
    "dev": "father dev"        // ä¸ tsc --watch ç±»ä¼¼
  },
  "keywords": [],
  "author": "æ´‹",
  "license": "ISC",
  "dependencies": {
    "father": "^4.1.0"
  }
}
```

### è¿è¡Œ dev è„šæœ¬

```
npm run dev
```


æ•ˆæœä¸ºä¸‹å›¾å³ç®—æˆåŠŸ

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e732539a08964fcdbd1b4d2e109c32ff~tplv-k3u1fbpfcp-watermark.image?)

## 2.åˆ›å»º <span style="color: #ff502c;background-color: #fff5f5">workspace</span> å·¥ä½œåŒº
åœ¨å·¥ä½œåŒºå†…çš„ package å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨<span style="color: #ff502c;background-color: #fff5f5">è½¯é“¾æ¥å¼•ç”¨</span>
```yaml
# pnpm-workspace.yaml(æ ¹ç›®å½•)
packages:
  - 'packages/*'
```
## 3.å­åŒ…æ­å»º
åˆ é™¤srcï¼Œæ–°å»º<span style="color: #ff502c;background-color: #fff5f5">packages</span>ç›®å½• åœ¨ packageç›®å½•ä¸‹ åˆ›å»ºå¦‚ä¸‹ç»“æ„ï¼š
```js
.
â”œâ”€â”€ package.json
â””â”€â”€ packages
    â”œâ”€â”€ packageA 
    â”œâ”€â”€ packageB
    â””â”€â”€ packageC
```
è¿™é‡Œä¸æ ¹ç›®å½•æ­å»ºåŸºæœ¬ä¸€è‡´ å¤§å®¶è‡ªå·±è¯•ç€åˆ›å»ºä¸€ä¸‹
<br>

æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4fcf4419be354d05be6e8bc709d27798~tplv-k3u1fbpfcp-watermark.image?)
#### é—®é¢˜1ï¼šæ ¹ç›®å½•ä¸­çš„ .fatherrc.ts ä¸ºä»€ä¹ˆè¦æ”¹åä¸º .fatherrc.base.ts (å†…å®¹ä¸å˜)
å› ä¸ºæˆ‘ä»¬è¿™è¾¹<span style="color: #ff502c;background-color: #fff5f5">å­ç›®å½•</span>ä¸­çš„ <span style="color: #ff502c;background-color: #fff5f5">.fatherrc.ts</span> é…ç½®æ–‡ä»¶è¦<span style="color: #ff502c;background-color: #fff5f5">ç»§æ‰¿æ ¹ç›®å½•</span>ä¸­çš„é…ç½®
```ts
import { defineConfig } from "father";

export default defineConfig({
  extends: '../../.fatherrc.base.ts'
})
```
#### é—®é¢˜2ï¼šä¸ºä»€ä¹ˆ tsconfig ä¸éœ€è¦åœ¨æ¯ä¸ªå­é¡¹ç›®é‡Œé¢å†å†™ä¸€ä»½å‘¢ï¼Ÿ
è¿˜è®°å¾— Monorepo æœ‰ä¸ª<span style="color: #ff502c;background-color: #fff5f5">ä¼˜ç‚¹</span>ä¹‹ä¸€  <span style="color: #ff502c;background-color: #fff5f5">å¯ä»¥ä½¿ç”¨ ç»Ÿä¸€çš„å·¥ç¨‹åŒ–é…ç½®</span>, åƒtsconfigæˆ‘ä»¬åªéœ€è¦åœ¨æ ¹ç›®å½•å†™ä¸€ä»½å³å¯åœ¨æ‰€æœ‰åŒ…é‡Œç”Ÿæ•ˆ

## 4.ä½¿ç”¨workspace
### 1.åœ¨æ‰€æœ‰å­é¡¹ç›® package.json ä¸­åŠ å…¥æ„å»ºè„šæœ¬
```diff
  "scripts": {
    "dev": "father dev",
+   "build": "father build"  
  },
```
### 2.åœ¨æ ¹ç›®å½• package.json ä¸­åŠ å…¥
```diff
  "scripts": {
    "dev": "father dev",
+   "build:all": "pnpm run -r build"
  },
```
### 3.åœ¨æ ¹ç›®å½•è¿è¡Œè„šæœ¬
```
npm run build:all
```
æ•ˆæœå¦‚ä¸‹ï¼Œæ‰€æœ‰å­åŒ…å…¨éƒ¨æ‰“åŒ…äº§ç‰© dist ç›®å½•æˆåŠŸï¼Œè¯´æ˜ workspace è®¾ç½®æˆåŠŸ
![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/56ba729b10ab43b18ed776edcab55b29~tplv-k3u1fbpfcp-watermark.image?)
### åŸç†ï¼špnpm run -r xxx 
<span style="color: #ff502c;background-color: #fff5f5">-r</span> æŒ‡çš„æ˜¯<span style="color: #ff502c;background-color: #fff5f5">é€’å½’</span> æ‰€ä»¥è¿™é‡Œä¼šé€’å½’æ‰§è¡Œæ‰€æœ‰<span style="color: #ff502c;background-color: #fff5f5">workspace</span>é‡Œçš„ xxx å‘½ä»¤ï¼Œä¸Šè¿°ç¤ºä¾‹ä¸­å³ä¸º build å‘½ä»¤
### â­ï¸â­ï¸â­ï¸â­ <span style="color: #ff502c;background-color: #fff5f5">æ ¸å¿ƒ:</span>4.ä½¿ç”¨è½¯é“¾æ¥
##### 1.ä¿®æ”¹ AåŒ… é…ç½®
```diff
//package/packageA/package.json
 "dependencies": {
+   "package-b": "workspace:*"
  }
```
è¿™é‡Œä¿®æ”¹å®Œæ¯•ä¾èµ–ä¹‹åä¸€å®šè¦é‡æ–°å®‰è£…ä¾èµ– <span style="color: #ff502c;background-color: #fff5f5">pnpm i</span><br>
å‡ºç°é“¾æ¥æ ‡è®°å³ç®—æˆåŠŸ ç‚¹å¼€è§‚å¯Ÿå‘ç° <span style="color: #ff502c;background-color: #fff5f5">package-b</span> å°±æ˜¯æˆ‘ä»¬æ—è¾¹çš„ <span style="color: #ff502c;background-color: #fff5f5">BåŒ…</span>

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/007e13985fc448009ddd31d98da8bf73~tplv-k3u1fbpfcp-watermark.image?)
##### 2.ä¿®æ”¹ AåŒ… å†…å®¹
```ts
// package/packageA/src/index.ts
import { yang } from 'package-b'
console.log(yang);
```
##### 3.ä¿®æ”¹ BåŒ… å†…å®¹
```ts
export const yang = 'yang from b'
```
##### 4.ä¹Ÿåˆ«å¿˜äº†ä¿®æ”¹ BåŒ… <span style="color: #ff502c;background-color: #fff5f5">å¯¼å‡ºçš„å…¥å£æ–‡ä»¶</span>
```diff
// package/packageB/package.json
- "main": "index.js",
+ "main": "./dist/index.js",
```
##### 5.åœ¨æ ¹ç›®å½•æ‰“åŒ…<span style="color: #ff502c;background-color: #fff5f5">æ‰€æœ‰å­åŒ…äº§ç‰©</span>
```
npm run build:all
```
##### 6.åœ¨AåŒ…ä¸­
```
node dist/index.js
```

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f5d7044412154450815b64cab51dc0de~tplv-k3u1fbpfcp-watermark.image?)

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ mini-umi çš„ Monorepo ä»“åº“å°±ç®—æ˜¯åŸºæœ¬<span style="color: #ff502c;background-color: #fff5f5">æ­å»ºæˆåŠŸ</span>äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•(ã€ƒ'â–½'ã€ƒ)<br>

å…ˆæ¥ç€å¾€ä¸‹çœ‹
# Monorepo ä¸­çš„Â <span style="color: #ff502c;background-color: #fff5f5">æ„å»ºé¡ºåº</span>é—®é¢˜ ä¸Â <span style="color: #ff502c;background-color: #fff5f5">å¾ªç¯ä¾èµ–</span>
### ä¸Šè¿°æ­¥éª¤ä¸­çš„ 2-4-5 å…¶å®æ˜¯å¾ˆæ–¹ä¾¿çš„
>5.åœ¨æ ¹ç›®å½•æ‰“åŒ…<span style="color: #ff502c;background-color: #fff5f5">æ‰€æœ‰å­åŒ…äº§ç‰©</span><br>
>npm run build:all
## é—®é¢˜ä¸€ï¼š<span style="color: #ff502c;background-color: #fff5f5">æ„å»ºé¡ºåº</span>é—®é¢˜ï¼š
å‰é¢æåˆ°äº† npm run build:all æ—¶ å…¶å®æ‰§è¡Œäº† <span style="color: #ff502c;background-color: #fff5f5">pnpm run -r build</span>

å®ƒä¼šå»è‡ªåŠ¨åˆ†æä¾èµ–å…³ç³»ï¼Œå¾—åˆ°<span style="color: #ff502c;background-color: #fff5f5">é€’å½’çš„é¡ºåº </span><br>
ä½ ä¼šå‘ç° å®ƒå…ˆæ‰§è¡Œäº† BåŒ…çš„build å†å»æ‰§è¡Œ AåŒ…çš„Build<br>
è¿™æ˜æ˜¾<span style="color: #ff502c;background-color: #fff5f5">ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸ</span>

å› ä¸ºæˆ‘ä»¬çš„ <span style="color: #ff502c;background-color: #fff5f5">AåŒ… ä¾èµ–äº BåŒ…çš„äº§ç‰©</span>ï¼Œæ‰€ä»¥æ­£ç¡®é¡ºåºåº”è¯¥æ˜¯ <span style="color: #ff502c;background-color: #fff5f5">å…ˆbuildå‡º BåŒ…çš„äº§ç‰©</span>ï¼Œ<span style="color: #ff502c;background-color: #fff5f5">å†build AåŒ…</span>

ä½†æ˜¯ï¼Œè¦æ˜¯ä¸ä½¿ç”¨ <span style="color: #ff502c;background-color: #fff5f5">pnpm run -r build</span>ï¼Œè¯¥æ€ä¹ˆè§£å†³æ„å»ºé¡ºåºçš„é—®é¢˜å‘¢ï¼Ÿ
### å¦‚ä½•è§£å†³<span style="color: #ff502c;background-color: #fff5f5">æ„å»ºé¡ºåº</span>é—®é¢˜å‘¢ï¼Ÿ
#### 1. æ‰‹åŠ¨ å…ˆbuild AåŒ… å†build BåŒ…
ä¼˜åŠ¿ï¼šå¯æ§<br>
åŠ£åŠ¿ï¼šç®¡ç†çš„å­åŒ…ä¸€æ—¦åºå¤§ï¼Œå¯èƒ½è¦<span style="color: #ff502c;background-color: #fff5f5">æ‰‹åŠ¨ build å‡ åæ¬¡</span>
#### 2. å†™ä¸åŒçš„è„šæœ¬ç»„åˆ 
è¿™ä¸ªæ–¹æ¡ˆå°±æ¯”è¾ƒå¤šäº†ï¼Œä½ å¯ä»¥å†™å„ç§å„æ ·çš„è„šæœ¬ç»„åˆåœ¨ä¸€èµ·å»ä¿è¯ä»–çš„æ„å»ºé¡ºåº<br>
ä¼˜åŠ¿ï¼šæ–¹æ¡ˆè¾ƒå¤š<br>
åŠ£åŠ¿ï¼šè¦å†™è„šæœ¬ æˆ‘æ‡’
#### 3. ä½¿ç”¨å¯åˆ†æçš„æ„å»º--<span style="color: #ff502c;background-color: #fff5f5">Turborepo</span>
å½“æˆ‘ä»¬ä½¿ç”¨ Turborepo åä»–ä¼šå»<span style="color: #ff502c;background-color: #fff5f5">è‡ªåŠ¨åˆ†æ</span>åŒ…çš„<span style="color: #ff502c;background-color: #fff5f5">å¼•ç”¨å…³ç³»</span>(è¿™ä¸<span style="color: #ff502c;background-color: #fff5f5">pnpm run -r build</span>æ˜¯ä¸€è‡´çš„)ï¼Œä»è€Œå¾—åˆ°<span style="color: #ff502c;background-color: #fff5f5">æ­£ç¡®çš„æ„å»ºé¡ºåº</span><br>
ä¸‹ä¸€å°èŠ‚å°†ä¸ºæˆ‘ä»¬çš„é¡¹ç›®å¼•å…¥ Turborepo
## é—®é¢˜äºŒï¼š<span style="color: #ff502c;background-color: #fff5f5">å¾ªç¯ä¾èµ–</span>é—®é¢˜
å¾ªç¯ä¾èµ–çš„ä¾‹å­å¾ˆç®€å•ï¼š<br>
AåŒ…ä¾èµ–äº†BåŒ… BåŒ…ä¾èµ–äº†AåŒ…<br>
è¿™ä¸ªé—®é¢˜ä¹ä¸€çœ‹å¾ˆä¸æ­£å¸¸ å‚»å­æ‰ä¼šè¿™ä¹ˆç”¨å§ ä½†æ˜¯ç¡®å®æœ‰å¯èƒ½å‡ºç° æ¯”æ–¹è¯´åœ¨<span style="color: #ff502c;background-color: #fff5f5">å¼•ç”¨ ts ç±»å‹</span> çš„æ—¶å€™<br>
å…¶å® pnpm workspace æ˜¯å¯ä»¥<span style="color: #ff502c;background-color: #fff5f5">æ”¯æŒå¾ªç¯ä¾èµ–</span>çš„<br>
é—®é¢˜åœ¨äº <span style="color: #ff502c;background-color: #fff5f5">Trubo ä¸æ”¯æŒå¾ªç¯ä¾èµ–</span>

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc03341af0444d4089392f1208689fb8~tplv-k3u1fbpfcp-watermark.image?)

æ‰€ä»¥æˆ‘ä»¬åœ¨ Monorepo ä»“åº“ä¸­åº”å°½é‡<span style="color: #ff502c;background-color: #fff5f5">é¿å…</span>å‡ºç° <span style="color: #ff502c;background-color: #fff5f5">å¾ªç¯ä¾èµ–</span> çš„é—®é¢˜
# Turborepo - <span style="color: #ff502c;background-color: #fff5f5">é«˜æ€§èƒ½</span>æ„å»ºç³»ç»Ÿ æ¥å…¥ä¸å®è·µ
## ä»€ä¹ˆæ˜¯ <span style="color: #ff502c;background-color: #fff5f5">Turborepo</span> ï¼Ÿ
>Turborepo is a <span style="color: #ff502c;background-color: #fff5f5">high-performance</span> build system for JavaScript and TypeScript codebases.
**Turborepo** æ˜¯ä¸€ä¸ªç”¨äº **JavaScript** å’Œ **TypeScript** ä»£ç åº“çš„<span style="color: #ff502c;background-color: #fff5f5">â€œé«˜æ€§èƒ½â€</span>æ„å»ºç³»ç»Ÿã€‚<br>
é€šä¿—ä¸€ç‚¹è®²ï¼Œä»–æ˜¯æˆ‘ä»¬åœ¨ **Monorepo** ä»“åº“ä¸­çš„ä¸€ç§<span style="color: #ff502c;background-color: #fff5f5">ä¼˜åŒ–æ„å»º</span>çš„<span style="color: #ff502c;background-color: #fff5f5">æ–¹æ¡ˆ</span><br>
è¿™ä¸€ç‚¹ä¸€å®šè¦åŒºåˆ†äº Mutirepo å’Œ Monorepo çš„ <span style="color: #ff502c;background-color: #fff5f5">ä»£ç ç»„ç»‡æ–¹æ¡ˆ</span>
## ä½¿ç”¨Turborepoæœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ
#### å®˜æ–¹çš„è¡¨è¿°æ˜¯ï¼š
>Turborepo leverages advanced build system techniques to speed up development,Â **both on your local machine and your CI/CD**.
>
> [1.Never do the same work twice](https://turbo.build/repo/docs/core-concepts/caching)
>
>[Turborepo remembers the output of any task you run - and can skip work that's already been done.](https://turbo.build/repo/docs/core-concepts/caching)
>
> [2.Maximum Multitasking](https://turbo.build/repo/docs/core-concepts/monorepos/running-tasks)
>
>[The way you run your tasks is probably not optimized. Turborepo speeds them up with smart scheduling, minimising idle CPU's.](https://turbo.build/repo/docs/core-concepts/monorepos/running-tasks)
#### ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼š
1.æ„å»ºç¼“å­˜ -- è€Œä¸”å¯ä»¥<span style="color: #ff502c;background-color: #fff5f5">è¿œç¨‹ç¼“å­˜</span>ï¼Œè¿™åœ¨å›¢é˜Ÿå¼€å‘ååˆ†æœ‰ç”¨<br>
2.æ™ºèƒ½è°ƒåº¦<span style="color: #ff502c;background-color: #fff5f5">æ„å»ºåŠ é€Ÿ</span>ï¼Œå‡å°‘ç©ºé—²CPU<br>
3.é€šè¿‡ <span style="color: #ff502c;background-color: #fff5f5">Pipeline</span> å®šä¹‰ä»»åŠ¡ä¹‹é—´çš„å…³ç³»ï¼ŒåŠ å¿«æ„å»ºé€Ÿåº¦<br>
4.æ–¹ä¾¿å¿«æ·çš„<span style="color: #ff502c;background-color: #fff5f5">é…ç½®æ–‡ä»¶</span><br>
å½“ç„¶ï¼Œå’ŒMonorepoä¸€æ ·ï¼Œå½“ä½ å»æ‰§è¡Œ <span style="color: #ff502c;background-color: #fff5f5">npm run build:all</span> è¿™ç§æ„å»ºè„šæœ¬æ—¶ï¼ŒTurborepoä¼šä¸ºä½ è‡ªåŠ¨æ ¹æ®å®ƒä»¬çš„ä¾èµ–å…³ç³»ï¼Œè¾¾åˆ°æœ€ä¼˜çš„æ„å»ºé¡ºåº
## å¦‚ä½•ä¸ºä¸€ä¸ªé¡¹ç›®æ¥å…¥ Turborepo?
å…¶å®è¿™éƒ¨åˆ†è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š

##### 1.ç¡®å®šä½ çš„ Monorepo é¡¹ç›®ä¸­çš„ workspace æ­£å¸¸
å› ä¸ºæ¥ä¸‹æ¥ Turborepo æ„å»ºæ˜¯è¦åŸºäºæˆ‘ä»¬çš„ workspace

##### 2.å®‰è£…Turbo
```
pnpm add turbo -Dw
```
##### 3.é…ç½® Turbo çš„é…ç½®æ–‡ä»¶
```json
//turbo.json è¿™é‡Œæ˜¯ä¸€å¥—å®Œæ•´çš„å®˜æ–¹ç¤ºä¾‹
{
  "$schema": "https://turbo.build/schema.json",
  "pipeline": { // è¿™æ˜¯ä¸Šé¢æåˆ°çš„ä»»åŠ¡ç®¡é“
    "build": {
      // A package's <span style="color: #ff502c;background-color: #fff5f5">build</span> script depends on that package's
      // dependencies and devDependencies
      // <span style="color: #ff502c;background-color: #fff5f5">build</span> tasks  being completed first
      // (the <span style="color: #ff502c;background-color: #fff5f5">^</span> symbol signifies <span style="color: #ff502c;background-color: #fff5f5">upstream</span>).
      "dependsOn": [
        "^build"
      ],
      // note: output globs are relative to each package's <span style="color: #ff502c;background-color: #fff5f5">package.json</span>
      // (and not the monorepo root)
      "outputs": [
        ".next/**"
      ]
    },
    "test": {
      // A package's <span style="color: #ff502c;background-color: #fff5f5">test</span> script depends on that package's
      // own <span style="color: #ff502c;background-color: #fff5f5">build</span> script being completed first.
      "dependsOn": [
        "build"
      ],
      "outputs": [],
      // A package's <span style="color: #ff502c;background-color: #fff5f5">test</span> script should only be rerun when
      // either a <span style="color: #ff502c;background-color: #fff5f5">.tsx</span> or <span style="color: #ff502c;background-color: #fff5f5">.ts</span> file has changed in <span style="color: #ff502c;background-color: #fff5f5">src</span> or <span style="color: #ff502c;background-color: #fff5f5">test</span> folders.
      "inputs": [
        "src/**/*.tsx",
        "src/**/*.ts",
        "test/**/*.ts",
        "test/**/*.tsx"
      ]
    },
    "lint": {
      // A package's <span style="color: #ff502c;background-color: #fff5f5">lint</span> script has no dependencies and
      // can be run whenever. It also has no filesystem outputs.
      "outputs": []
    },
    "deploy": {
      // A package's <span style="color: #ff502c;background-color: #fff5f5">deploy</span> script depends on the <span style="color: #ff502c;background-color: #fff5f5">build</span>,
      // <span style="color: #ff502c;background-color: #fff5f5">test</span>, and <span style="color: #ff502c;background-color: #fff5f5">lint</span> scripts of the same package
      // being completed. It also has no filesystem outputs.
      "dependsOn": [
        "build",
        "test",
        "lint"
      ],
      "outputs": []
    }
  }
}

```

##### 4.æ·»åŠ .gitignore
å°†å®ƒçš„<span style="color: #ff502c;background-color: #fff5f5">ç¼“å­˜æ–‡ä»¶</span> ignore æ‰ï¼Œé˜²æ­¢ä¸Šä¼ åˆ° Github ä»“åº“
```diff
// gitignore
+ .turbo
```

##### 5.æ›¿æ¢æ„å»ºè„šæœ¬
```diff
- â€buildâ€œ: "xxxx"
+ "build": "turbo run build"
```

##### 6.(å¯é€‰)è¿œç¨‹æ„å»ºç¼“å­˜
```
npx turbo login   // ç™»å½•è¿œç¨‹ç¼“å­˜è´¦å·
npx turbo link    // å°†å½“å‰æ„å»ºä»“åº“ä¸è¿œç«¯ link
```
<span style="color: #ff502c;background-color: #fff5f5">è¿œç¨‹æ„å»ºç¼“å­˜</span> åœ¨<span style="color: #ff502c;background-color: #fff5f5">å›¢é˜ŸååŒå¼€å‘</span>çš„æ—¶å€™èƒ½æå‡ä¸å°‘çš„é€Ÿåº¦

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„ Turborepo æ¥å…¥åŸºæœ¬ä¸Šå°±å®Œæˆäº†ï¼Œåªéœ€è¦æ‰§è¡Œ <span style="color: #ff502c;background-color: #fff5f5">npm run build</span> å³å¯çœ‹åˆ°æ•ˆæœ

ä¸‹é¢æ˜¯ <span style="color: #ff502c;background-color: #fff5f5">å¼€æºé¡¹ç›®</span> å®æˆ˜ 
## Turborepo å®æˆ˜æ¡ˆä¾‹
è¿™è¾¹æˆ‘ç”¨<span style="color: #ff502c;background-color: #fff5f5">èš‚èšAntVå›¢é˜Ÿ</span>æ–°å¼€æºçš„ [GraphInsight](https://github.com/antvis/GraphInsight) ä¸ºä¾‹æ¥å…¥ **Turborepo**

è¿™æ˜¯ä»–ç°åœ¨çš„ <span style="color: #ff502c;background-color: #fff5f5">package.json</span>
```json
  "scripts": {
    "preinstall": "npx only-allow pnpm",
    "postinstall": "npm run build:all:es",
    "build:all:es": "pnpm run -r build:es",
    "start": "cd packages/gi-site && npm run start",
    "gi-common-component": "cd packages/gi-common-components && npm run build:es",
    "gi-sdk": "cd packages/gi-sdk && npm run build:es",
    "gi-assets-basic": "cd packages/gi-assets-basic && npm run build:es",
    "gi-assets-advance": "cd packages/gi-assets-advance && npm run build:es",
    "gi-assets-algorithm": "cd packages/gi-assets-algorithm && npm run build:es",
    "gi-assets-scene": "cd packages/gi-assets-scene && npm run build:es",
    "gi-assets-graphscope": "cd packages/gi-assets-graphscope && npm run build:es",
    "gi-assets-neo4j": "cd packages/gi-assets-neo4j && npm run build:es",
    "gi-assets-tugraph": "cd packages/gi-assets-tugraph && npm run build:es",
    "gi-theme-antd": "cd packages/gi-theme-antd && npm run build:es",
    "build": "npm run build:site && npm run move:dist",
    "build:assets": "cd packages/gi-assets-basic && NODE_OPTIONS=--max_old_space_size=2048 npm run build",
    "build:basicAssets": "cd packages/gi-assets-basic && NODE_OPTIONS=--max_old_space_size=2048 npm run build",
    "build:core": "cd packages/gi && NODE_OPTIONS=--max_old_space_size=2048 npm run build",
    "build:site": "cd packages/gi-site && pnpm install && NODE_OPTIONS=--max_old_space_size=2048 npm run build",
    "build:testing": "cd packages/gi-assets-testing && NODE_OPTIONS=--max_old_space_size=2048 npm run build",
    "clean:all": "pnpm run -r clean",
    "core": "cd packages/gi && npm run start",
    "move:dist": "node ./scripts/deploy.js",
    "site": "cd packages/gi-site && NODE_OPTIONS=--max_old_space_size=2048 npm run start"
  },
```
ä¹‹å‰æ˜¯

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/916710ebc3fc4c049f663bbf90584479~tplv-k3u1fbpfcp-watermark.image?)

è¿™é‡Œçš„ <span style="color: #ff502c;background-color: #fff5f5">build:all:es</span> ä¸ºäº†<span style="color: #ff502c;background-color: #fff5f5">ä¿éšœæ‰§è¡Œé¡ºåº</span>ï¼Œå±å®æ˜¯ **'è¾›è‹¦'** å®ƒäº†ï¼Œæ‰€ä»¥æˆ‘ç»™ä»–æäº†prï¼Œå°†ä»–ç”¨ <span style="color: #ff502c;background-color: #fff5f5">pnpm run -r build:es</span> æ›¿æ¢æ‰äº†

#### ç°åœ¨æˆ‘ä»¬ä½¿ç”¨ <span style="color: #ff502c;background-color: #fff5f5">Turborepo</span> æ›¿æ¢æ‰å®ƒ
##### 1.å®‰è£… Turbo
```
pnpm add turbo -Dw 
```
##### 2.åŠ ä¸Šé…ç½®æ–‡ä»¶ Pipeline
```diff
// turbo.json
+{
+  "$schema": "https://turbo.build/schema.json",
+  "pipeline": {
+    "build:es": {
+      "dependsOn": [
+        "^build:es"
+      ],
+      "outputs": [
+        "es/**",
+        "lib/**"
+      ]
+    }
+  },
+  "globalDependencies": [
+    ".prettierrc.js"
+  ]
+}
```
##### 3.æ›¿æ¢æ„å»ºè„šæœ¬
```diff
// package.json
-     "build:all:es": "pnpm run -r build:es",
+     "build:all:es": "turbo run build:es",
```
##### 4.ç¼“å­˜æ–‡ä»¶åŠ å…¥gitignore
```diff
// gitignore
+ .turbo
```
æ‰§è¡Œ <span style="color: #ff502c;background-color: #fff5f5">"npm run build:all:es"</span> å³å¯çœ‹åˆ°æ•ˆæœ:
##### â­ï¸ æ›¿æ¢ä¹‹å‰çš„ "pnpm run -r build:es" 
å…±è®¡ç”¨æ—¶ï¼š5.1+9.5+10.2+28.2+20.4+26 s
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b818841a1d07411d81bff43de811d03b~tplv-k3u1fbpfcp-watermark.image?)
##### â­ï¸ æ›¿æ¢ä¹‹åçš„ "turo run build:es" ç¬¬ä¸€æ¬¡æ„å»º+ç¼“å­˜
å…±è®¡ç”¨æ—¶ 44 s
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8b4e49dfb0154288803c630c9447331a~tplv-k3u1fbpfcp-watermark.image?)
##### â­ï¸ ç¼“å­˜ä¹‹åçš„ "turo run build:es" æ„å»º
å¹³å‡æ—¶é—´ï¼š <span style="color: #ff502c;background-color: #fff5f5">800+ms</span>
![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8fca144781654ec7b7eb6a084a248f07~tplv-k3u1fbpfcp-watermark.image?)

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dbca28d787be49efae430e5b41f41ec8~tplv-k3u1fbpfcp-watermark.image?)

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6d83192d53794595920efdd9f75371be~tplv-k3u1fbpfcp-watermark.image?)

ä» <span style="color: #ff502c;background-color: #fff5f5">40s+</span> ä¼˜åŒ–åˆ°äº† <span style="color: #ff502c;background-color: #fff5f5">1s</span> ä»¥ä¸‹ï¼Œåªèƒ½è¯´éå¸¸é¦™äº†

ç›´æ¥ç»™ AntV æäº¤ [Pr](https://github.com/antvis/GraphInsight/pull/66)

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/79044f9efe4d4093bf61ead529415a35~tplv-k3u1fbpfcp-watermark.image?)

## å°ç»“ï¼š

**æœ¬å°èŠ‚æˆ‘ä»¬**

**1.é¦–å…ˆä¸ºå¤§å®¶ä»‹ç»äº†ä»€ä¹ˆæ˜¯ Monorepoã€‚å®ƒå…¶å®æ˜¯ä¸€ç§ä»£ç ä»“åº“çš„ç»„ç»‡ç®¡ç†æ–¹å¼ï¼Œé€šè¿‡Monorepoçš„ç®¡ç†ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆ<span style="color: #ff502c;background-color: #fff5f5">æ–¹ä¾¿</span>çš„åœ¨ workspace ä¸­å¼€å‘æœ¬åœ° npmåº“ï¼Œ<span style="color: #ff502c;background-color: #fff5f5">ç»Ÿä¸€è§„èŒƒé…ç½®</span>ç­‰**

**2.é€šè¿‡ä»£ç å¸¦ç€å¤§å®¶æ­å»ºå¥½äº†ä¸€ä¸ªå®ç”¨çš„ <span style="color: #ff502c;background-color: #fff5f5">Monorepoä»“åº“</span>ï¼Œé˜²æ­¢å¤§å®¶è¸©å‘ï¼Œå¹¶å­¦ä¼šäº†ä¸€äº›Monorepoå¼€å‘ä¸­çš„<span style="color: #ff502c;background-color: #fff5f5">å°æŠ€å·§</span>ï¼Œä¹Ÿå¼•å‡ºäº†æˆ‘ä»¬ä¸‹æ–‡ä¸­çš„ <span style="color: #ff502c;background-color: #fff5f5">pnpmæ„å»ºé¡ºåºé—®é¢˜</span> ä»¥åŠ <span style="color: #ff502c;background-color: #fff5f5">Turborepo</span>**

**3.ä¸ºå¤§å®¶ä»‹ç»äº† pnpm ä½¿ç”¨ Monorepo ç®¡ç†ä»“åº“å‡ºç°çš„ä¸¤ä¸ªé—®é¢˜ï¼š<span style="color: #ff502c;background-color: #fff5f5">æ„å»ºé¡ºåº</span>ä»¥åŠ<span style="color: #ff502c;background-color: #fff5f5">å¾ªç¯ä¾èµ–</span>é—®é¢˜ä»¥åŠå®ƒä»¬çš„è§£å†³æ–¹æ¡ˆ**

**4.å¼•å…¥äº†ç°ä»£é«˜æ€§èƒ½æ„å»ºæ–¹æ¡ˆ-<span style="color: #ff502c;background-color: #fff5f5">Turborepo</span>ï¼Œç®€è¿°äº†<span style="color: #ff502c;background-color: #fff5f5">å¦‚ä½•</span>åœ¨ä¸€ä¸ª Monorepo é¡¹ç›®ä¸­æ¥å…¥Turboï¼Œå¹¶ä»¥èš‚èšä½“éªŒæŠ€æœ¯éƒ¨å¼€æºäº§å“ <span style="color: #ff502c;background-color: #fff5f5">GraphInsight</span> ä¸ºäº†è¿›è¡Œå®æˆ˜æ¥å…¥æ¼”ç¤ºæ•ˆæœ**

**ä¸‹ä¸€å°èŠ‚**

## å°èŠ‚æ€è€ƒï¼š

**1.Monorepo ç®¡ç†ä»“åº“ ç©¶ç«Ÿæœ‰å“ªäº›å¥½å¤„å‘¢ï¼Ÿå®ƒä¸<span style="color: #ff502c;background-color: #fff5f5">ä¼ ç»Ÿ Mutirepoä»“åº“</span> æœ‰å“ªäº›ä¼˜åŠ£ä½ èƒ½è¯´çš„ä¸Šæ¥å—**<br>
**2.ä½ èƒ½åœ¨æˆ‘ä»¬çš„æ–°å»ºçš„ mini-umi é¡¹ç›®ä¸­æ¥å…¥ Turborepo å—ï¼Œè¯•ä¸€ä¸‹å§**<br>
**3.ä½ çŸ¥é“æ–°å»º <span style="color: #ff502c;background-color: #fff5f5">.fatherrc.ts</span> é…ç½®æ–‡ä»¶çš„æ—¶å€™ ä¸ºä»€ä¹ˆ export default åé¢è¦ä½¿ç”¨ä¸€ä¸ª<span style="color: #ff502c;background-color: #fff5f5">defineConfig å‡½æ•°</span>å—**<br>
2.1 å·²çŸ¥ä¿¡æ¯ä¸€ï¼šdefineConfigå‡½æ•° å‚æ•°æ˜¯ <span style="color: #ff502c;background-color: #fff5f5">config</span> è¿”å›å€¼ä¹Ÿæ˜¯<span style="color: #ff502c;background-color: #fff5f5">config</span><br>
2.2 å·²çŸ¥ä¿¡æ¯äºŒï¼š<span style="color: #ff502c;background-color: #fff5f5">vite é…ç½®æ–‡ä»¶</span>ä¸­ä¹Ÿæ˜¯åŒæ ·çš„ç”¨æ³•

```ts
import { defineConfig } from "father";
export default defineConfig({
  cjs: {
    output: 'dist',
    sourcemap: true
  }
})
